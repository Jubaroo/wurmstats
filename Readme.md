Wurm Stats
==========
A utility to assist with reading and formatting the `stats.xml` file generated by the Wurm server.

A demo using Wurm Online's server status can be found at http://brain.death.rocks/~jonathan/wurmstats/stats.html 
(Note: There is an intentional delay to show the loading animation)

This utility uses the following Javascript libraries:
* [Jquery](http://jquery.com/)
* [RequireJS](http://requirejs.org/)
* [Knockout.js](http://knockoutjs.com/)
* [Moment.js](http://momentjs.com/)
* [Moment-timezone](http://momentjs.com/timezone/)
* [Moment-duration-format](https://github.com/jsmreese/moment-duration-format)
* [jsTimezoneDetect](http://pellepim.bitbucket.org/jstz/)

It also uses [PureCSS](http://purecss.io/) as a CSS framework, but this is not a requirement for functionality.

All libraries are included via CDNs:

*Javascript*
* JQuery: `//ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min`
* RequireJS: `//cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.js`
* Knockout.js: `//ajax.aspnetcdn.com/ajax/knockout/knockout-3.3.0`
* Moment.js: `//cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min`
* Moment-timezone: `//cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.4/moment-timezone-with-data.min`
* Moment-duration-format: `//cdnjs.cloudflare.com/ajax/libs/moment-duration-format/1.3.0/moment-duration-format`
* JsTimezoneDetect: `//cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.6/jstz.min`

*CSS*
* PureCSS: `//cdn.jsdelivr.net/pure/0.6.0/pure-min.css`
* PureCSS Grids: `//cdn.jsdelivr.net/pure/0.6.0/grids-responsive-min.css`

Structure
---------
* html/ - Publicly visible folder
    * stats.html - Contains the HTML to include or link to for stats.
    * js/ - Javascript folder
        * loader.js - Handles loading of the dependencies and the stats.js script
        * stats.js - The main program that reads in and outputs the stats.xml data
    * css/ - CSS folder (generated by sass)
        * stats.css - The actual stylesheet, generated by sass (but may be modified)
* php/ - PHP for servers that support it
    * stats.php - A wrapper for users who need cross-domain or are unable to host stats.xml in a publicly accessible manner
* scss/ - Sass source files for generating CSS
    * stats.scss - The stats.css source file
* .gitignore - The ignore file
* gulpfile.js - Used in development, supports browserSync, Sass
* package.json - NPM package details.
* Readme.md - This file :)

Configuration
-------------
## PHP

### $pathToStats
If you choose to use the PHP wrapper, you must host it on a server that supports PHP.
To set it up, open the `stats.php` file and edit `$pathToStats` to point to your `stats.xml` file.
Example:
```
$pathToStats = "/home/jonathan/stats.xml";
```
You may also specify a URL:
```
$pathToStats = "http://brain.death.rocks/~jonathan/stats.xml";
```
If the server is unable to read the path, then it will return an HTTP 500 error.

### $domain
This is an optional variable which can be set to your website's domain for added security against cross-domain attacks.
Example:
```
$domain = "brain.death.rocks";
```
**Note:** Changing this setting may break your feed if you do not set your domain properly. If you have issues, set it back to the default: `$domain = "*"`

## Javascript

### statsUrl
If you are using the PHP wrapper, you should ensure that statsUrl is pointing to that.
Otherwise point statsUrl to your stats.xml and ensure that it is on the same domain as your website.
Example:
```
var statsUrl = "http://brain.death.rocks/~jonathan/stats.php";
```

### autoRefresh
This is the interval at which the script should refresh the data, in seconds. A setting of `0` disables auto-refreshing.
Example:
```
var autoRefresh = 10; // 10 second refresh
var autoRefresh = 0;  // Auto-refreshing disabled
```

### serverName
This is an optional value that populates the name of the server. Since this data is not polled from the feed, it must be set.
This field does not show in the resulting web page if left blank: `var serverName = "";`.
Example:
```
var serverName = "Flowers001";
```

### dateFormat
Specifies a format for the timestamp displayed in the feed. Please see [Momento.js | Docs](http://momentjs.com/docs/#/displaying/format/) for more information.
Example:
```
var dateFormat = "dddd, MMMM d, YYYY";
```
Will output a date of: `Monday, July 1, 2016`

### timezone
Specifies your server's timezone for use in decoding the timestamp sent in the XML.
Example:
```
var timezone = "Europe/Stockholm";
```

### localTZ
If true, ```localTZ``` will enable the use of ```jstz.determine()``` to detect the timezone of the browser and display the timestamp in the user's local timezone. If false or unable to detect, it will fall back on the server timezone.
Example:
```
var localTZ = true;
```

### customUptimeFormat
Defaults to ```false```, which uses a custom function to use the correct plurals for days, hours, etc.
If not false, specifies a format for the uptime string in the feed. Please see [Momento Duration Format](https://github.com/jsmreese/moment-duration-format) for more information.
Examples:
```
var customUptimeFormat = false; // This will use the built-in method
// Or this will use the string provided as the format.
var customUptimeFormat = "y [years], M [months], W [weeks], D [days], H [hours], m [minutes]";
```
If given a value of `23260` seconds, it will output: `6 hours, 34 minutes`

Advanced
--------
## Javascript
Since this uses Knockout.js, all of the data is available through data binds.

### Data Binds
* $root.serverName - This is the configured name of the server. (Not from feed)
* $root.uptime - This is the time in seconds the server has been up.
* $root.status - A string sent by the server to indicate status.
* $root.wurmtime - The current Wurm time sent by the server when stats.xml was generated.
* $root.weather - The current wind conditions when the stats.xml was generated.
* $root.timestamp - The UNIX timestamp indicating when the stats.xml was generated.
* $root.servers - A list of servers sent in the feed
    * name - The name of the server
    * maxplayers - The max players set in the server configuration
    * online - True if the server is online, false if it is offline. (This is determined by maxplayers, a value of `0` indicates a server is offline.)
    * players - Current player count
* $root.lastUpdated - This is a a formatted version of `$root.timestamp`
* $root.upSince - A formatted version of `$root.uptime`

If you make any changes to the stats.html, ensure that the `data-bind` attributes are properly set.

## HTML
This project uses `div` instead of the tables found in the original `stats.html`.

The loading animation is courtesy of [this CodePen](https://codepen.io/alanshortis/pen/eJLVXr).

## CSS/SCSS
This project supports the use of Sass/SCSS, though it is optional. The classes used in the HTML file are as follows:
* .container - The main container, everything is contained in this.
* .row - Defines a data row
* .label - Defines a label cell, such as the name of a server
* .data - Defines a data cell, such as the population totals
* .offline - Used only when displaying data for an offline server in the server list.

PureCSS is also used for the grid formatting, but the entire package is included. The PureCSS classes used are as follows:
* pure-g - This is the base grid container, each row is a container.
* pure-u-1-3 - Tells the cell to use 1/3 of the parent container's width
* pure-u-2-3 - Tells the cell to use 2/3 of the parent container's width

I've also included some simple @media queries to make it look better on mobile, if desired. Again this can all be overridden with a custom CSS.
You can even do your own HTML, so long as you data-bind correctly so the data shows.

Development
-----------
Simply issue an `npm install` for all the dependencies to be installed. There are no dependencies to use this project. This is a completely optional step.

Installation
------------
Installation will vary greatly depending on your setup. In general though:
1. Ensure that your `stats.xml` is either viewable to the Internet or that you're able to use `stats.php` as a wrapper for it.
2. Copy or link the entire `html/` folder into your web root. Do not change the structure without changing the paths in the files.
3. Use the Configuration settings above to set up the utility and test!
